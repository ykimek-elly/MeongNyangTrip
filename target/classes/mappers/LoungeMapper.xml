<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team.meongnyang.mapper.LoungeMapper">

	<select id="selectAllFeeds" resultType="com.team.meongnyang.dto.FeedDTO">
		SELECT
			f.feed_id     AS feedId,
			f.nickname    AS nickname,
			f.content     AS content,
			f.image_url   AS imageUrl,
			f.place_id    AS placeId,
			f.place_name  AS placeName,
			f.like_count  AS likeCount,
			f.reg_date    AS createdAt,
			
			/* 댓글 수 서브쿼리 */
			(SELECT COUNT(*) FROM COMMENT WHERE feed_id = f.feed_id) AS commentCount,
			
			/* 좋아요 여부 서브쿼리 (여기서 f.feed_id를 쓰기 때문에 별칭 필수) */
			(SELECT COUNT(*) FROM FEED_LIKE WHERE feed_id = f.feed_id AND nickname = #{nickname}) > 0 AS isLiked
			
		FROM FEED f  ORDER BY f.feed_id DESC
	</select>

	<select id="checkUserLike" resultType="int">
		SELECT COUNT(*) FROM FEED_LIKE
		WHERE feed_id = #{feedId} AND nickname = #{nickname}
	</select>

	<insert id="insertFeedLike">
		INSERT INTO FEED_LIKE (feed_id, nickname)
		VALUES (#{feedId}, #{nickname})
	</insert>

	<delete id="deleteFeedLike">
		DELETE FROM FEED_LIKE
		WHERE feed_id = #{feedId} AND nickname = #{nickname}
	</delete>

	<update id="plusLikeCount">
		UPDATE FEED SET like_count = like_count + 1 WHERE feed_id = #{feedId}
	</update>

	<update id="minusLikeCount">
		UPDATE FEED SET like_count = like_count - 1 WHERE feed_id = #{feedId}
	</update>

	<delete id="deleteAllFeeds">
		TRUNCATE TABLE FEED
	</delete>

	<insert id="insertFeed"
		parameterType="com.team.meongnyang.dto.FeedDTO">
		INSERT INTO FEED (
		nickname, content, image_url,
		place_id, place_name, like_count, reg_date
		) VALUES (
		#{nickname},
		#{content}, #{imageUrl}, #{placeId}, #{placeName}, #{likeCount},
		#{createdAt}
		)
	</insert>


	<select id="selectAllTalks"
		resultType="com.team.meongnyang.dto.TalkDTO">
		SELECT
		talk_id AS talkId,
		nickname AS nickname,
		content AS
		content,
		location_name AS locationName,
		bg_color AS bgColor,
		reg_date AS
		createdAt
		FROM TALK
		ORDER BY talk_id DESC
	</select>

	<delete id="deleteTalk">
		DELETE FROM TALK
		WHERE talk_id = #{talkId} AND
		nickname = #{nickname}
	</delete>

	<insert id="insertTalk"
		parameterType="com.team.meongnyang.dto.TalkDTO">
		INSERT INTO TALK (
		nickname, content, location_name,
		bg_color, reg_date
		) VALUES (
		#{nickname}, #{content}, #{locationName},
		#{bgColor}, #{createdAt}
		)
	</insert>


	<select id="selectAllComments"
		resultType="com.team.meongnyang.dto.CommentDTO">
		SELECT
		comment_id AS commentId,
		feed_id AS feedId,
		nickname AS
		nickname,
		content AS content,
		reg_date AS createdAt
		FROM COMMENT
		ORDER BY
		comment_id ASC
	</select>

	<delete id="deleteAllComments">
		TRUNCATE TABLE COMMENT
	</delete>

	<insert id="insertComment"
		parameterType="com.team.meongnyang.dto.CommentDTO">
		INSERT INTO COMMENT (
		comment_id, feed_id, nickname,
		content, reg_date
		) VALUES (
		#{commentId}, #{feedId}, #{nickname},
		#{content}, #{createdAt}
		)
	</insert>

	<delete id="deleteFeed">
		DELETE FROM FEED
		WHERE feed_id = #{feedId} AND
		nickname = #{nickname}
	</delete>

	<select id="selectTalkComments"
		resultType="com.team.meongnyang.dto.TalkCommentDTO">
		SELECT
		id, talk_id AS talkId, nickname, content, reg_date AS regDate
		FROM TALK_COMMENT
		WHERE talk_id = #{talkId}
		ORDER BY id ASC
	</select>

	<insert id="insertTalkComment"
		parameterType="com.team.meongnyang.dto.TalkCommentDTO">
		INSERT INTO TALK_COMMENT (talk_id, nickname, content, reg_date)
		VALUES (#{talkId}, #{nickname}, #{content}, NOW())
	</insert>

	<delete id="deleteTalkComment">
		DELETE FROM TALK_COMMENT
		WHERE id = #{id} AND nickname = #{nickname}
	</delete>
	
	<update id="updateFeed" parameterType="com.team.meongnyang.dto.FeedDTO">
        UPDATE FEED
        SET 
            content = #{content},
            place_id = #{placeId},
            place_name = #{placeName}
            <if test="imageUrl != null">
                , image_url = #{imageUrl}
            </if>
        WHERE feed_id = #{feedId} AND nickname = #{nickname}
    </update>

</mapper>
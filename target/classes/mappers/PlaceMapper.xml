<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.team.meongnyang.mapper.PlaceMapper">

	<insert id="insertPlace">
		INSERT INTO place (
		title, cat, loc, img, rating,
		review_count, content_id, mapx, mapy
		) VALUES (
		#{title}, #{cat},
		#{loc}, #{img}, #{rating}, #{reviewCount}, #{contentId},
		#{mapX},
		#{mapY}
		)
	</insert>

	<select id="countByContentId" resultType="int">
		SELECT COUNT(*) FROM
		place WHERE content_id = #{contentId}
	</select>

	<select id="countAll" resultType="int">
		SELECT COUNT(*) FROM place
	</select>

	<select id="selectPlaceList"
		resultType="com.team.meongnyang.dto.PlaceDTO">
		SELECT
		id, title, cat, loc, img, rating,
		review_count AS reviewCount,
		content_id AS contentId,
		mapx AS mapX, mapy AS mapY
		FROM place
		<where>
			<if test="region != null and region != ''">
				AND (loc LIKE CONCAT('%', #{region}, '%') OR title LIKE
				CONCAT('%',
				#{region}, '%'))
			</if>
			<if test="category != null and category != 'all'">
				AND cat = #{category}
			</if>
		</where>
		ORDER BY rating DESC, review_count DESC, id DESC
	</select>

	<select id="selectPlaceById"
		resultType="com.team.meongnyang.dto.PlaceDTO">
		SELECT
		id, title, cat, loc, img, rating,
		review_count AS
		reviewCount,
		content_id AS contentId,
		mapx AS mapX, mapy AS mapY,
		description AS "desc",
		tel, homepage,
		facility_info AS facilityInfo FROM
		place
		WHERE id = #{id}
	</select>

	<select id="selectReviewsByPlaceId" resultType="map">
		SELECT
		id,
		user_id
		AS userId,
		content,
		rating,
		DATE_FORMAT(reg_date, '%Y.%m.%d') AS regDate
		FROM review
		WHERE place_id = #{placeId}
		ORDER BY reg_date DESC
	</select>

	<update id="updatePlaceDesc">
		UPDATE place
		SET description = #{desc},
		tel = #{tel},
		homepage = #{homepage},
		facility_info = #{facilityInfo}
		WHERE content_id
		= #{contentId}
	</update>

	<update id="updatePlaceStats">
		UPDATE place
		SET
		review_count = (SELECT COUNT(*) FROM review WHERE place_id = #{placeId}),
		rating = (SELECT IFNULL(ROUND(AVG(rating), 1), 0.0) FROM review WHERE
		place_id = #{placeId})
		WHERE id = #{placeId}
	</update>

	<insert id="insertReview">
		INSERT INTO review (place_id, user_id, content,
		rating)
		VALUES (#{placeId}, #{userId}, #{content}, #{rating})
	</insert>



</mapper>